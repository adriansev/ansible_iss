- hosts: "{{ target | default('kuberadm.spacescience.ro') }}"
  gather_facts: True
  vars:
    chrony_base_ip: "pub46"

    profile: virtual-guest
    tuned_daemon_mode: false

    iptables_v4_custom_table_setup: | #
        *nat
        -A PREROUTING -p tcp --source 10.10.180.0/24 --dport 53 -j DNAT --to-destination 10.10.180.1:53
        -A PREROUTING -p udp --source 10.10.180.0/24 --dport 53 -j DNAT --to-destination 10.10.180.1:53
        -A POSTROUTING --source 10.10.180.0/24 -j MASQUERADE
        COMMIT

    ip_v4_filter_custom_rule_after_ipsets: | #
        -A FORWARD -m physdev --physdev-is-bridged -j ACCEPT
        -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED,SNAT,DNAT -j ACCEPT
        -A FORWARD -p icmp -j ACCEPT
        -A FORWARD -s 10.10.180.0/24 -m conntrack --ctstate NEW -j ACCEPT
        -A FORWARD -s 10.10.180.0/24 -m state --state NEW -j ACCEPT


    iptables_v6_custom_table_setup: ""
    ip_v6_filter_custom_rule_after_ipsets: ""

    ipset_tables:
      - accept_ip:
      - accept_ip6:
      - accept_net:
        - "10.10.180.0/24"
      - accept_net6:
      - accept_port_ip:
      - accept_port_ip6:
      - accept_port_net:
      - accept_port_net6:
      - accept_port_tcp:
        - "60000"
      - accept_port_udp:

    sysctl_list:
      - "{{ playbook_dir }}/../additions/sysctl.d/60-memory.conf"
      - "{{ playbook_dir }}/../additions/sysctl.d/70-mtu.conf"
      - "{{ playbook_dir }}/../additions/sysctl.d/72-packet_tuning.conf"
      - "{{ playbook_dir }}/../additions/sysctl.d/82-ipv4.conf"
      - "{{ playbook_dir }}/../additions/sysctl.d/82-ipv6.conf"
      - "{{ playbook_dir }}/../additions/sysctl.d/82-netcore.conf"
      - "{{ playbook_dir }}/../additions/sysctl.d/84-fs.conf"
      - "{{ playbook_dir }}/../additions/sysctl.d/84-kernel.conf"
      - "{{ playbook_dir }}/../additions/sysctl.d/99-delayacct.conf"
      - "{{ playbook_dir }}/../additions/sysctl.d/99-inotify.conf"
      - "{{ playbook_dir }}/../additions/sysctl.d/99-security.conf"
      - "{{ playbook_dir }}/../additions/sysctl.d/80-network_buffers_gen.conf"
      - "{{ playbook_dir }}/../additions/sysctl.d/90-frontend-forward.conf"

    tuning_list:
      - "{{ playbook_dir }}/../additions/root_tuning.d/05-fq_codel.tune_eth"


  vars_files:
    - "{{ playbook_dir }}/../additions/ipset_blacklist/blacklist_gw.yml"

  tasks:
  - ansible.builtin.include_tasks:
      file: "{{ task_item }}"
    loop_control:
      loop_var: task_item
    with_items:
      - "tasks/00basic_tools.yml"
      - "tasks/pkg_utils_task.yml"
      - "tasks/pkg_kernelml_install_task.yml"
      - "tasks/pkg_dnsmasq_task.yml"
      - "tasks/pkg_igtfca_task.yml"
      - "tasks/pkg_lsc_vomses_task.yml"
      - "tasks/pkg_utils_task.yml"
      - "tasks/cfg_firewall_task.yml"
      - "tasks/cfg_fail2ban_task.yml"
      - "tasks/cfg_chrony_task.yml"
      - "tasks/cfg_ssh_task.yml"
      - "tasks/cfg_lldpd_task.yml"
      - "tasks/cfg_tuned_task.yml"
      - "tasks/tune_sysctl_task.yml"
      - "tasks/tune_scripts_task.yml"






##      - "tasks/cfg_gmond_issaf.yml"






